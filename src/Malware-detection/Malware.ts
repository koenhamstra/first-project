class MalwareGame extends ClassLoader {
  // The canvas
  private canvas: HTMLCanvasElement;
  private ctx: CanvasRenderingContext2D;
  private rectangle: Rectangles[];
  //images 
  private phoneImage: HTMLImageElement;
  private whatsAppImage: HTMLImageElement;
  private messageImage: HTMLImageElement;
  private emailImage: HTMLImageElement;
  private emailMessage: HTMLImageElement;
  private warning: boolean;
  private verification: HTMLImageElement;
  private itteration: number;
  //positions 
  private xPos: number;
  private yPos: number;
  private xPos_whatsapp: number;
  private yPos_whatsapp: number;
  private xPos_answer: number;
  private yPos_answer1: number;
  private yPos_answer2: number;
  // frameindex and index
  private frameIndex: number;
  private index: number;

  public constructor(canvas: HTMLCanvasElement, itteration: number) {
    super(canvas,new Audio ("assets/levels-music/Pixel-City-Groovin.mp3"))
    this.canvas = canvas;
    // Mouse event
    // document.addEventListener("click", this.mouseHandler);
    //  the canvas 
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    //X and Y positions for the phone picture 
    this.xPos = this.canvas.width * 0.7 / 2;
    this.yPos = this.canvas.height * 0.3 / 2;
    const acceptButton = document.getElementById("accept");
    acceptButton.addEventListener("click", this.WhatsAppAccept);
 
    const rejectButton= document.getElementById("reject");
    rejectButton.addEventListener("click",this.WhatsAppReject);

    const warningButton= document.getElementById("warning");
    warningButton.addEventListener("click",this.warningClick);

    // phone image 
    this.phoneImage = this.loadNewImage("assets/img/phone.png");
    // verification message
    this.verification = this.loadNewImage("assets/img/verification.png")
    //X and Y positions for the whatsapp picture 
    this.xPos_whatsapp = this.canvas.width * 0.5 / 2;
    this.yPos_whatsapp = this.canvas.height * 0.5 / 2;
    //whatsapp logo
    this.whatsAppImage = this.loadNewImage("assets/img/whatsapp.png");
    //email message
    this.emailMessage = this.loadNewImage("assets/img/email-message.jpg");
    //email logo
    this.emailImage = this.loadNewImage("assets/img/email.png");
    // X and Y positions for the answers 1/2
    this.xPos_answer = this.canvas.width * 16/ 20;
    this.yPos_answer1 = this.canvas.height * 9 / 20;
    this.yPos_answer2 = this.canvas.height * 12 / 20;

    //warningscreen
    this.warning = false;
    // click itteration when click on logo
    this.itteration = itteration;
    // the Canvas rendering context 2D
    this.ctx = this.canvas.getContext('2d');
    //Whatsapp message image  
    this.messageImage = this.loadNewImage("assets/img/whatsapp-message.png")
    //frameindex and index
    this.frameIndex = 0;
    this.index = 0;
    //backgroundcolor
    document.body.style.backgroundColor = "#CCFFE5";
  }



  /**
   * This MUST be an arrow method in order to keep the `this` variable
   * working correctly. It will be overwritten by another object otherwise
   * caused by javascript scoping behaviour.
   */
  public draw = () => {
    this.frameIndex++;
    this.index++;
    console.log (this.itteration);
    //call the method to draw
    this.drawWhatsApp();
    //the mousehandler 
    document.addEventListener("click", this.mouseHandler);
    //warningscreen 
    if (this.warning === true) {
      console.log("warning")
      this.warningScreen();
    }
    
  }

  private mouseHandler = (event: MouseEvent) => {
    if (this.whatsApp_Pic(event)) {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.drawImage(this.messageImage, this.xPos_whatsapp, this.yPos_whatsapp);

      if (this.itteration === 0) {
        this.writeTextToCanvas("Can you trust this message?", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
        document.getElementById("reject").removeAttribute("hidden");
        document.getElementById("accept").removeAttribute("hidden");
      }
      if (this.itteration === 1) {
        this.writeTextToCanvas("Can you trust this message?", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
        document.getElementById("reject").removeAttribute("hidden");
        document.getElementById("accept").removeAttribute("hidden");
      }
      if (this.itteration === 2) {
        this.writeTextToCanvas("Can you trust this message?", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
        document.getElementById("reject").removeAttribute("hidden");
        document.getElementById("fakeAccept").removeAttribute("hidden");
        const accept=document.getElementById("fakeAccept");
        accept.addEventListener("click",this.WhatsAppReject)

      }
    }
    //to click away when the warningscreen is shown

  }

  // the warning screen method
  private warningScreen = () => {
      document.getElementById("warning").removeAttribute("hidden");
      if (this.index % 3 === 0) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        document.body.style.backgroundColor = "blue";
        this.writeTextToCanvas("WARNING", 60, this.xPos, this.yPos, "center", "yellow");
        // this.writeTextToCanvas("CLICK HERE TO STOP", 30, this.rectangle[2].getXPos() + (this.rectangle[2].getWidth() / 2), this.rectangle[2].getYPos() + (this.rectangle[2].getHeight() / 2), "center", "yellow");
      }
      if (this.index % 6 === 0) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        document.body.style.backgroundColor = "red";
        this.writeTextToCanvas("WARNING", 60, this.xPos, this.yPos, "center", "yellow");
        // this.writeTextToCanvas("CLICK HERE TO STOP", 30, this.rectangle[2].getXPos() + (this.rectangle[2].getWidth() / 2), this.rectangle[2].getYPos() + (this.rectangle[2].getHeight() / 2), "center", "yellow");
        this.index = 0;
      }
  }

  /**
* Writes text to the canvas
* @param {string} text - Text to write
* @param {number} fontSize - Font size in pixels
* @param {number} xCoordinate - Horizontal coordinate in pixels
* @param {number} yCoordinate - Vertical coordinate in pixels
* @param {string} alignment - Where to align the text
* @param {string} color - The color of the text
*/
  private writeTextToCanvas(
    text: string,
    fontSize: number = 20,
    xCoordinate: number,
    yCoordinate: number,
    alignment: CanvasTextAlign = "center",
    color: string = "white"
  ) {
    this.ctx.font = `${fontSize}px sans-serif`;
    this.ctx.fillStyle = color;
    this.ctx.textAlign = alignment;
    this.ctx.fillText(text, xCoordinate, yCoordinate);
  }

  /**
 * Method to load an image
 * @param {HTMLImageElement} source
 * @return HTMLImageElement - returns an image
 */
  public loadNewImage(source: string): HTMLImageElement {
    const img = new Image();
    img.src = source;
    return img;
  }


  /**
   * to draw the phone image and other images like whatsapp, email and the messages.
   */
  private drawWhatsApp = (): void => {
    if (this.frameIndex === 10) {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.drawImage(this.phoneImage, this.xPos, this.yPos);
      if (this.itteration === 0) {
        this.writeTextToCanvas("Wait for a message!", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black")
      }
      if (this.itteration === 1) {
        this.writeTextToCanvas("Whatsapp will never ask your personal information beside your phonenumber", 35, this.canvas.width / 2, this.canvas.height * 0.1, "center", "black")
      }
      if (this.itteration === 2) {
        this.writeTextToCanvas("Your bank will never ask your personal infromation through mail or text", 35, this.canvas.width / 2, this.canvas.height * 0.1, "center", "black")
      }
      if (this.itteration === 3) {
        this.writeTextToCanvas("you can trust this message because it is an in app verification", 35, this.canvas.width / 2, this.canvas.height * 0.1, "center", "black");
      }
    }
    if (this.frameIndex === 500) {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.ctx.drawImage(this.whatsAppImage, this.xPos_whatsapp, this.yPos_whatsapp);
      if (this.itteration >= 0) {
        this.writeTextToCanvas("You got a message, click to open", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
      }
      if (this.itteration >= 1) {
        this.writeTextToCanvas("You got a message, click to open", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
      }
      if (this.itteration >= 2) {
        this.writeTextToCanvas("You got a message, click to open", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
      }
      if (this.itteration >= 3) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.writeTextToCanvas("Well done, You completed the game, Press Space to continue", 35, this.canvas.width * 0.75, this.canvas.height * 0.25, "center", "black");
        this.itteration =4;
      }
    }
  }
  // click event on the logo image
  private whatsApp_Pic = (event: MouseEvent) => {
    return event.clientX >= this.xPos_whatsapp && event.clientX < this.xPos_whatsapp + this.whatsAppImage.width && event.clientY >= this.yPos_whatsapp && event.clientY <= this.yPos_whatsapp + this.whatsAppImage.height;
  }
  //click event on the accept button
  private WhatsAppAccept = () => {
    this.itteration++;
    this.index = 0;
    if (this.itteration<3) {
      this.warning=true
    }
    this.whatsAppImage = this.emailImage;
    this.messageImage = this.emailMessage;
    if (this.itteration >= 2) {
      this.whatsAppImage = this.loadNewImage("assets/img/whatsapp.png");
      this.messageImage = this.verification;
      this.drawWhatsApp();
    }
    // return event.clientX >= this.rectangle[0].getXPos() && event.clientX < this.rectangle[0].getXPos() + this.rectangle[0].getWidth() && event.clientY >= this.rectangle[0].getYPos() && event.clientY <= this.rectangle[0].getYPos() + this.rectangle[0].getHeight();
    document.getElementById("accept").setAttribute("hidden","hidden");
    document.getElementById("reject").setAttribute("hidden","hidden");
  }
  //click event on the reject button
  private WhatsAppReject = () => {
    this.itteration++;
    this.frameIndex = 0;
    if (this.itteration >= 2) {
      this.whatsAppImage = this.loadNewImage("assets/img/whatsapp.png");
      this.messageImage = this.verification;
      this.drawWhatsApp();
    } else {
      this.whatsAppImage = this.emailImage;
      this.messageImage = this.emailMessage;
      this.drawWhatsApp();
    }
    document.getElementById("reject").setAttribute("hidden","hidden");
    document.getElementById("accept").setAttribute("hidden","hidden"); 
    document.getElementById("fakeAccept").setAttribute("hidden","hidden");  
    // return event.clientX >= this.rectangle[1].getXPos() && event.clientX < this.rectangle[1].getXPos() + this.rectangle[1].getWidth() && event.clientY >= this.rectangle[1].getYPos() && event.clientY <= this.rectangle[1].getYPos() + this.rectangle[1].getHeight();
    
  }
  //click event on the warning click
  private warningClick = () => {
    this.frameIndex = 0;
    document.body.style.backgroundColor = "#CCFFE5";
    this.warning = false;
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    this.drawWhatsApp();
    document.getElementById("warning").setAttribute("hidden","hidden");  
  }

  public done =()=> {
    if (this.itteration===4){
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      document.body.style.backgroundImage = "url('src/moving/back2.jpg')";
      document.body.style.backgroundSize = "cover";
      return true
    }
    return false
  }

}
